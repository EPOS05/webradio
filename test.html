<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Site</title>
</head>
<body>
    <!-- Hidden audio element for playback -->
    <audio id="audioPlayer" style="display: block;" controls></audio>

    <script>
        // Function to parse query parameters from URL
        function getQueryParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Function to fetch MP3 files JSON
        async function fetchMP3FilesJSON(jsonFileUrl) {
            try {
                const response = await fetch(jsonFileUrl);
                if (response.ok) {
                    const json = await response.json();
                    const mp3Files = json.mp3_files;
                    if (mp3Files.length > 0) {
                        // Fetch and concatenate MP3 files into one continuous stream
                        const mp3Stream = await concatenateMP3Files(mp3Files);
                        // Start playing audio
                        playAudio(mp3Stream);
                    } else {
                        console.log('No MP3 files available in JSON.');
                    }
                } else {
                    console.error("Fetch Error:", response.statusText);
                }
            } catch (error) {
                console.error('Error fetching MP3 files JSON:', error);
            }
        }

        // Function to concatenate MP3 files into one continuous stream
        async function concatenateMP3Files(mp3Files) {
            let mp3Stream = new Blob();
            for (const mp3File of mp3Files) {
                const response = await fetch(mp3File);
                const mp3Blob = await response.blob();
                mp3Stream = new Blob([mp3Stream, mp3Blob], { type: 'audio/mp3' });
            }
            return URL.createObjectURL(mp3Stream);
        }

        // Function to play audio continuously like a live radio stream
        function playAudio(mp3StreamUrl) {
            const audioPlayer = document.getElementById('audioPlayer');
            // Set source of audio player to the continuous stream
            audioPlayer.src = mp3StreamUrl;
            console.log("Loading:", mp3StreamUrl);
            // Autoplay audio
            audioPlayer.autoplay = true;
            // Loop the audio stream
            audioPlayer.loop = true;
            // Play audio
            audioPlayer.play()
                .then(() => {
                    console.log("Playing:", mp3StreamUrl);
                })
                .catch(error => console.error("Error playing:", mp3StreamUrl, error));
        }

        // Fetch MP3 files JSON or play MP3 from URL when the page loads
        const jsonFileUrl = getQueryParameter('json');
        const mp3Url = getQueryParameter('mp3');
        if (mp3Url) {
            // Start playing audio from MP3 URL
            playAudio(mp3Url);
        } else if (jsonFileUrl) {
            // Fetch MP3 files from JSON URL and start playing
            fetchMP3FilesJSON(jsonFileUrl);
        } else {
            console.error('MP3 URL or JSON file URL not provided.');
        }
    </script>
</body>
</html>
